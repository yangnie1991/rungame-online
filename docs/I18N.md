# å›½é™…åŒ–æ–‡æ¡£

## æ¦‚è¿°

RunGame ä½¿ç”¨ `next-intl` å®ç°å®Œæ•´çš„å›½é™…åŒ–æ”¯æŒï¼Œæä¾›ç±»å‹å®‰å…¨çš„ç¿»è¯‘å’Œè·¯ç”±ç®¡ç†ã€‚

**æ”¯æŒè¯­è¨€**:
- ğŸ‡¬ğŸ‡§ **en** (English) - é»˜è®¤è¯­è¨€
- ğŸ‡¨ğŸ‡³ **zh** (ä¸­æ–‡)
- ğŸ‡ªğŸ‡¸ **es** (EspaÃ±ol)
- ğŸ‡«ğŸ‡· **fr** (FranÃ§ais)

## é…ç½®æ–‡ä»¶

### 1. è·¯ç”±é…ç½® `i18n/routing.ts`

å®šä¹‰è¯­è¨€åˆ—è¡¨ã€é»˜è®¤è¯­è¨€ï¼Œå¹¶å¯¼å‡ºç±»å‹å®‰å…¨çš„å¯¼èˆª APIã€‚

```typescript
import { defineRouting } from 'next-intl/routing'
import { createSharedPathnamesNavigation } from 'next-intl/navigation'

export const routing = defineRouting({
  // æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
  locales: ['en', 'zh', 'es', 'fr'],

  // é»˜è®¤è¯­è¨€
  defaultLocale: 'en',

  // è·¯ç”±ç­–ç•¥
  localePrefix: 'as-needed', // é»˜è®¤è¯­è¨€æ— å‰ç¼€
})

// å¯¼å‡ºç±»å‹å®‰å…¨çš„å¯¼èˆª API
export const { Link, redirect, usePathname, useRouter } =
  createSharedPathnamesNavigation(routing)
```

### 2. è¯·æ±‚é…ç½® `i18n/config.ts`

é…ç½®å¦‚ä½•ä¸ºæ¯ä¸ªè¯·æ±‚åŠ è½½ç¿»è¯‘æ¶ˆæ¯ã€‚

```typescript
import { getRequestConfig } from 'next-intl/server'
import { routing } from './routing'

export default getRequestConfig(async ({ locale }) => {
  // éªŒè¯è¯­è¨€æ˜¯å¦æ”¯æŒ
  if (!routing.locales.includes(locale as any)) {
    notFound()
  }

  return {
    messages: (await import(`./messages/${locale}.json`)).default,
  }
})
```

### 3. ç¿»è¯‘æ–‡ä»¶ `i18n/messages/`

JSON æ ¼å¼çš„ç¿»è¯‘æ–‡ä»¶ï¼Œæ¯ä¸ªè¯­è¨€ä¸€ä¸ªæ–‡ä»¶ã€‚

```
i18n/messages/
â”œâ”€â”€ en.json  # è‹±æ–‡ç¿»è¯‘
â”œâ”€â”€ zh.json  # ä¸­æ–‡ç¿»è¯‘
â”œâ”€â”€ es.json  # è¥¿ç­ç‰™è¯­ç¿»è¯‘
â””â”€â”€ fr.json  # æ³•è¯­ç¿»è¯‘
```

**ç¤ºä¾‹** (`en.json`):
```json
{
  "home": {
    "title": "Welcome to RunGame",
    "description": "Play free online games"
  },
  "games": {
    "allGames": "All Games",
    "featured": "Featured Games",
    "playNow": "Play Now"
  },
  "navigation": {
    "home": "Home",
    "games": "Games",
    "about": "About",
    "contact": "Contact"
  }
}
```

**å¯¹åº”ä¸­æ–‡** (`zh.json`):
```json
{
  "home": {
    "title": "æ¬¢è¿æ¥åˆ° RunGame",
    "description": "å…è´¹åœ¨çº¿æ¸¸æˆ"
  },
  "games": {
    "allGames": "æ‰€æœ‰æ¸¸æˆ",
    "featured": "ç²¾é€‰æ¸¸æˆ",
    "playNow": "ç«‹å³æ¸¸ç©"
  },
  "navigation": {
    "home": "é¦–é¡µ",
    "games": "æ¸¸æˆ",
    "about": "å…³äº",
    "contact": "è”ç³»"
  }
}
```

## è·¯ç”±è§„åˆ™

### URL æ ¼å¼

- **é»˜è®¤è¯­è¨€ (en)**: æ— å‰ç¼€
  ```
  /games
  /games/play/puzzle-game
  /about
  ```

- **å…¶ä»–è¯­è¨€**: å¸¦è¯­è¨€å‰ç¼€
  ```
  /zh/games
  /zh/games/play/puzzle-game
  /zh/about

  /es/games
  /fr/games
  ```

### è·¯ç”±ç»“æ„

```
app/(site)/[locale]/    # æ‰€æœ‰ç”¨æˆ·è·¯ç”±å¿…é¡»åœ¨ [locale] ä¸‹
  â”œâ”€â”€ page.tsx          # é¦–é¡µ: / æˆ– /zh
  â”œâ”€â”€ games/
  â”‚   â”œâ”€â”€ page.tsx      # /games æˆ– /zh/games
  â”‚   â””â”€â”€ play/[slug]/
  â”‚       â””â”€â”€ page.tsx  # /games/play/xxx æˆ– /zh/games/play/xxx
  â”œâ”€â”€ about/page.tsx
  â””â”€â”€ [pageType]/page.tsx
```

## å¯¼èˆª API

### âš ï¸ é‡è¦è§„åˆ™

**åœ¨ç”¨æˆ·ç½‘ç«™ (`(site)`) ä¸­**:

âŒ **ç¦æ­¢ä½¿ç”¨** Next.js åŸç”Ÿå¯¼èˆª:
```typescript
import Link from 'next/link'              // âŒ é”™è¯¯
import { useRouter } from 'next/navigation' // âŒ é”™è¯¯
```

âœ… **å¿…é¡»ä½¿ç”¨** next-intl å¯¼èˆª:
```typescript
import { Link, useRouter, usePathname } from '@/i18n/routing'  // âœ… æ­£ç¡®
```

### 1. Link ç»„ä»¶

```typescript
import { Link } from '@/i18n/routing'

// åŸºæœ¬ç”¨æ³• - è‡ªåŠ¨æ·»åŠ å½“å‰è¯­è¨€å‰ç¼€
<Link href="/games">All Games</Link>
// æ¸²æŸ“ä¸º: /games (en) æˆ– /zh/games (zh)

// æŒ‡å®šè¯­è¨€
<Link href="/games" locale="zh">ä¸­æ–‡ç‰ˆ</Link>
// æ€»æ˜¯æ¸²æŸ“ä¸º: /zh/games

// ä¼ é€’å‚æ•°
<Link href={`/games/play/${slug}`}>Play</Link>

// å¤–éƒ¨é“¾æ¥ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
<Link href="https://external.com">External</Link>
```

### 2. useRouter Hook

```typescript
import { useRouter } from '@/i18n/routing'

function MyComponent() {
  const router = useRouter()

  const handleClick = () => {
    // ç¼–ç¨‹å¼å¯¼èˆª - è‡ªåŠ¨å¤„ç†è¯­è¨€å‰ç¼€
    router.push('/games')

    // æŒ‡å®šè¯­è¨€
    router.push('/games', { locale: 'zh' })

    // æ›¿æ¢å†å²è®°å½•
    router.replace('/games')

    // è¿”å›ä¸Šä¸€é¡µ
    router.back()
  }

  return <button onClick={handleClick}>Navigate</button>
}
```

### 3. usePathname Hook

```typescript
import { usePathname } from '@/i18n/routing'

function LanguageSwitcher() {
  const pathname = usePathname()
  // è¿”å›ä¸å¸¦è¯­è¨€å‰ç¼€çš„è·¯å¾„å: "/games"

  return (
    <div>
      <Link href={pathname} locale="en">English</Link>
      <Link href={pathname} locale="zh">ä¸­æ–‡</Link>
      <Link href={pathname} locale="es">EspaÃ±ol</Link>
      <Link href={pathname} locale="fr">FranÃ§ais</Link>
    </div>
  )
}
```

### 4. redirect å‡½æ•° (Server)

```typescript
import { redirect } from '@/i18n/routing'

// Server Component æˆ– Server Action
export default async function MyPage() {
  const user = await getUser()

  if (!user) {
    redirect('/login')  // è‡ªåŠ¨å¤„ç†è¯­è¨€å‰ç¼€
  }

  // ...
}
```

## ç¿»è¯‘æ–‡æœ¬

### Server Components

```typescript
import { getTranslations } from 'next-intl/server'

export default async function HomePage({ params }: Props) {
  const { locale } = await params
  const t = await getTranslations()

  return (
    <div>
      <h1>{t('home.title')}</h1>
      <p>{t('home.description')}</p>
    </div>
  )
}
```

### Client Components

```typescript
'use client'

import { useTranslations } from 'next-intl'

export function GameCard() {
  const t = useTranslations('games')

  return (
    <div>
      <button>{t('playNow')}</button>
    </div>
  )
}
```

### å¸¦å‚æ•°çš„ç¿»è¯‘

```json
{
  "welcome": "Welcome, {name}!",
  "gamesCount": "You have {count} games"
}
```

```typescript
const t = useTranslations()

t('welcome', { name: 'John' })
// è¾“å‡º: "Welcome, John!"

t('gamesCount', { count: 5 })
// è¾“å‡º: "You have 5 games"
```

### å¤æ•°å½¢å¼

```json
{
  "gamesCount": "{count, plural, =0 {No games} =1 {One game} other {# games}}"
}
```

```typescript
t('gamesCount', { count: 0 })  // "No games"
t('gamesCount', { count: 1 })  // "One game"
t('gamesCount', { count: 5 })  // "5 games"
```

## æ•°æ®åº“ç¿»è¯‘

### ç¿»è¯‘æ¶æ„

æ•°æ®åº“é‡‡ç”¨ç¿»è¯‘åˆ†ç¦»æ¶æ„ï¼š
- **ä¸»è¡¨**: å­˜å‚¨ä¸å¯ç¿»è¯‘æ•°æ® + **è‹±æ–‡å†…å®¹**
- **ç¿»è¯‘è¡¨**: å­˜å‚¨**å…¶ä»–è¯­è¨€**çš„ç¿»è¯‘

### æŸ¥è¯¢ç¿»è¯‘æ•°æ®

#### è¾…åŠ©å‡½æ•° `lib/i18n-helpers.ts`

```typescript
/**
 * æ„å»ºè¯­è¨€æŸ¥è¯¢æ¡ä»¶ï¼ˆå½“å‰è¯­è¨€ + en å›é€€ï¼‰
 */
export function buildLocaleCondition(locale: string) {
  if (locale === 'en') {
    return { locale: 'en' }
  }

  return {
    locale: { in: [locale, 'en'] }
  }
}

/**
 * è·å–ç¿»è¯‘å†…å®¹ï¼ˆå¸¦å›é€€ï¼‰
 */
export function getTranslationWithFallback<T>(
  translations: Array<T & { locale: string }>,
  locale: string
): T | undefined {
  if (locale === 'en') {
    return translations.find(t => t.locale === 'en')
  }

  // ä¼˜å…ˆå½“å‰è¯­è¨€
  const current = translations.find(t => t.locale === locale)
  if (current) return current

  // å›é€€åˆ°è‹±æ–‡
  return translations.find(t => t.locale === 'en')
}
```

#### æŸ¥è¯¢æ¨¡å¼

**è‹±æ–‡æŸ¥è¯¢** (ä¸éœ€è¦ç¿»è¯‘è¡¨):
```typescript
if (locale === 'en') {
  const game = await prisma.game.findUnique({
    where: { slug },
    select: {
      id: true,
      slug: true,
      title: true,        // ç›´æ¥ä½¿ç”¨ä¸»è¡¨è‹±æ–‡å­—æ®µ
      description: true,
      // ä¸åŠ è½½ translations
    },
  })

  return game
}
```

**å…¶ä»–è¯­è¨€æŸ¥è¯¢** (åŠ è½½ç¿»è¯‘):
```typescript
const game = await prisma.game.findUnique({
  where: { slug },
  include: {
    translations: {
      where: buildLocaleCondition(locale),  // æŸ¥è¯¢ [locale, 'en']
      select: {
        locale: true,
        title: true,
        description: true,
      },
    },
  },
})

// è·å–ç¿»è¯‘å†…å®¹ï¼ˆå¸¦å›é€€åˆ°è‹±æ–‡ï¼‰
const translation = game.translations.find(t => t.locale === locale)
const title = translation?.title || game.title  // å›é€€åˆ°ä¸»è¡¨è‹±æ–‡
const description = translation?.description || game.description
```

### ç¿»è¯‘è¾…åŠ©å‡½æ•°

`lib/helpers/game-content.ts` æä¾›ç»Ÿä¸€çš„ç¿»è¯‘è·å–ï¼š

```typescript
import { getGameTitle, getGameDescription } from '@/lib/helpers/game-content'

const title = getGameTitle(locale, game.title, game.translations)
const description = getGameDescription(locale, game.description, game.translations)
```

## ä¸­é—´ä»¶é…ç½®

`middleware.ts` å¤„ç†è¯­è¨€è·¯ç”±ï¼š

```typescript
import createMiddleware from 'next-intl/middleware'
import { routing } from './i18n/routing'

const intlMiddleware = createMiddleware(routing)

export default async function middleware(request: NextRequest) {
  // 1. å›½é™…åŒ–è·¯ç”±å¤„ç†
  const response = intlMiddleware(request)

  // 2. å…¶ä»–ä¸­é—´ä»¶é€»è¾‘ï¼ˆè®¤è¯ç­‰ï¼‰
  // ...

  return response
}

export const config = {
  matcher: [
    // åŒ¹é…æ‰€æœ‰è·¯å¾„é™¤äº† apiã€_nextã€é™æ€æ–‡ä»¶
    '/((?!api|_next|.*\\..*).*)',
  ],
}
```

## è¯­è¨€åˆ‡æ¢

### è¯­è¨€åˆ‡æ¢å™¨ç»„ä»¶

```typescript
'use client'

import { usePathname } from '@/i18n/routing'
import { Link } from '@/i18n/routing'

const languages = [
  { code: 'en', name: 'English', flag: 'ğŸ‡¬ğŸ‡§' },
  { code: 'zh', name: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' },
  { code: 'es', name: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸' },
  { code: 'fr', name: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·' },
]

export function LanguageSwitcher() {
  const pathname = usePathname()

  return (
    <div>
      {languages.map((lang) => (
        <Link
          key={lang.code}
          href={pathname}
          locale={lang.code}
        >
          {lang.flag} {lang.name}
        </Link>
      ))}
    </div>
  )
}
```

### æµè§ˆå™¨è¯­è¨€æ£€æµ‹

`next-intl` è‡ªåŠ¨æ ¹æ®ä»¥ä¸‹ä¼˜å…ˆçº§æ£€æµ‹è¯­è¨€ï¼š
1. URL è·¯å¾„ä¸­çš„è¯­è¨€ä»£ç 
2. Cookie ä¸­ä¿å­˜çš„è¯­è¨€åå¥½
3. `Accept-Language` è¯·æ±‚å¤´
4. é»˜è®¤è¯­è¨€ (en)

## SEO ä¸å›½é™…åŒ–

### ç”Ÿæˆè¯­è¨€æ›¿ä»£é“¾æ¥

```typescript
import { type Metadata } from 'next'

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { locale } = await params

  return {
    alternates: {
      canonical: `/${locale === 'en' ? '' : locale + '/'}games`,
      languages: {
        'en': '/games',
        'zh': '/zh/games',
        'es': '/es/games',
        'fr': '/fr/games',
      },
    },
  }
}
```

### Open Graph è¯­è¨€æ ‡ç­¾

```typescript
export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { locale } = await params

  return {
    openGraph: {
      locale: locale,
      alternateLocale: ['en', 'zh', 'es', 'fr'].filter(l => l !== locale),
    },
  }
}
```

## æ·»åŠ æ–°è¯­è¨€

### æ­¥éª¤

1. **æ›´æ–°è·¯ç”±é…ç½®** `i18n/routing.ts`:
```typescript
export const routing = defineRouting({
  locales: ['en', 'zh', 'es', 'fr', 'de'],  // æ·»åŠ  'de'
  defaultLocale: 'en',
})
```

2. **åˆ›å»ºç¿»è¯‘æ–‡ä»¶** `i18n/messages/de.json`:
```json
{
  "home": {
    "title": "Willkommen bei RunGame"
  }
}
```

3. **æ·»åŠ åˆ°æ•°æ®åº“** (Language è¡¨):
```typescript
await prisma.language.create({
  data: {
    code: 'de',
    name: 'German',
    nativeName: 'Deutsch',
    nameCn: 'å¾·è¯­',
    isEnabled: true,
    sortOrder: 5,
  },
})
```

4. **ä¸ºç°æœ‰å†…å®¹æ·»åŠ ç¿»è¯‘**:
   - æ¸¸æˆç¿»è¯‘ (GameTranslation)
   - åˆ†ç±»ç¿»è¯‘ (CategoryTranslation)
   - æ ‡ç­¾ç¿»è¯‘ (TagTranslation)
   - é¡µé¢ç±»å‹ç¿»è¯‘ (PageTypeTranslation)

## æœ€ä½³å®è·µ

### 1. å¯¼èˆª

âœ… **æ­£ç¡®**:
```typescript
import { Link } from '@/i18n/routing'
<Link href="/games">Games</Link>
```

âŒ **é”™è¯¯**:
```typescript
import Link from 'next/link'
<Link href="/games">Games</Link>
```

### 2. è·¯ç”±

âœ… **æ­£ç¡®**:
```typescript
import { useRouter } from '@/i18n/routing'
const router = useRouter()
router.push('/games')
```

âŒ **é”™è¯¯**:
```typescript
import { useRouter } from 'next/navigation'
const router = useRouter()
router.push('/games')
```

### 3. æ‰‹åŠ¨æ„é€  URL

âœ… **æ­£ç¡®**:
```typescript
<Link href="/games">Games</Link>
// è‡ªåŠ¨å¤„ç†: /games (en) æˆ– /zh/games (zh)
```

âŒ **é”™è¯¯**:
```typescript
<Link href={`/${locale}/games`}>Games</Link>
// å¯èƒ½å¯¼è‡´: /en/games (åº”è¯¥æ˜¯ /games)
```

### 4. ç¿»è¯‘é”®å‘½å

âœ… **æ­£ç¡®**:
```json
{
  "games": {
    "title": "Games",
    "playNow": "Play Now"
  }
}
```

âŒ **é”™è¯¯**:
```json
{
  "GAMES_TITLE": "Games",
  "play-now": "Play Now"
}
```

ä½¿ç”¨åµŒå¥—å¯¹è±¡å’Œé©¼å³°å‘½åã€‚

### 5. æ•°æ®åº“æŸ¥è¯¢

âœ… **æ­£ç¡®**:
```typescript
// è‹±æ–‡è·³è¿‡ç¿»è¯‘è¡¨
translations: locale === 'en' ? false : {
  where: buildLocaleCondition(locale)
}
```

âŒ **é”™è¯¯**:
```typescript
// æ€»æ˜¯åŠ è½½ç¿»è¯‘è¡¨ï¼ˆæ€§èƒ½æµªè´¹ï¼‰
translations: {
  where: { locale }
}
```

### 6. å›é€€å¤„ç†

âœ… **æ­£ç¡®**:
```typescript
const translation = translations.find(t => t.locale === locale)
const title = translation?.title || game.title  // å›é€€åˆ°è‹±æ–‡
```

âŒ **é”™è¯¯**:
```typescript
const title = translations.find(t => t.locale === locale)?.title
// å¦‚æœæ²¡æœ‰ç¿»è¯‘ï¼Œè¿”å› undefined
```

## å¸¸è§é—®é¢˜

### 1. è¯­è¨€åˆ‡æ¢åé¡µé¢æ²¡æœ‰æ›´æ–°

**åŸå› **: ä½¿ç”¨äº† Next.js åŸç”Ÿ `Link` è€Œä¸æ˜¯ `next-intl` çš„ `Link`ã€‚

**è§£å†³**:
```typescript
import { Link } from '@/i18n/routing'  // âœ… æ­£ç¡®
```

### 2. é»˜è®¤è¯­è¨€ URL æœ‰å¤šä½™å‰ç¼€

**åŸå› **: æ‰‹åŠ¨æ·»åŠ äº†è¯­è¨€å‰ç¼€ã€‚

**è§£å†³**:
```typescript
<Link href="/games">Games</Link>
// ä¸è¦å†™æˆ: <Link href="/en/games">
```

### 3. ç¿»è¯‘ä¸æ˜¾ç¤º

**åŸå› **: ç¿»è¯‘é”®è·¯å¾„é”™è¯¯æˆ–ç¼ºå°‘ç¿»è¯‘ã€‚

**è§£å†³**:
1. æ£€æŸ¥ JSON æ–‡ä»¶ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„é”®
2. æ£€æŸ¥é”®è·¯å¾„æ˜¯å¦æ­£ç¡® (`games.title` vs `games.playNow`)
3. ç¡®ä¿æ‰€æœ‰è¯­è¨€éƒ½æœ‰å¯¹åº”ç¿»è¯‘

### 4. æ•°æ®åº“ç¿»è¯‘ä¸ºç©º

**åŸå› **: æŸ¥è¯¢æ¡ä»¶é”™è¯¯æˆ–ç¿»è¯‘æ•°æ®ä¸å­˜åœ¨ã€‚

**è§£å†³**:
1. ä½¿ç”¨ `buildLocaleCondition()` æ„å»ºæŸ¥è¯¢æ¡ä»¶
2. ç¡®ä¿æ•°æ®åº“ä¸­æœ‰å¯¹åº”è¯­è¨€çš„ç¿»è¯‘è®°å½•
3. å®ç°å›é€€åˆ°è‹±æ–‡çš„é€»è¾‘

## æµ‹è¯•

### æµ‹è¯•ä¸åŒè¯­è¨€

```bash
# è‹±æ–‡ï¼ˆé»˜è®¤ï¼‰
http://localhost:3000/games

# ä¸­æ–‡
http://localhost:3000/zh/games

# è¥¿ç­ç‰™è¯­
http://localhost:3000/es/games

# æ³•è¯­
http://localhost:3000/fr/games
```

### æµ‹è¯•è¯­è¨€åˆ‡æ¢

1. è®¿é—®ä»»æ„é¡µé¢
2. ç‚¹å‡»è¯­è¨€åˆ‡æ¢å™¨
3. éªŒè¯ URL å’Œå†…å®¹éƒ½æ­£ç¡®æ›´æ–°
4. éªŒè¯é¡µé¢ç»“æ„ä¿æŒä¸å˜

### æµ‹è¯•æ•°æ®åº“ç¿»è¯‘

1. åœ¨ç®¡ç†åå°åˆ›å»ºæ¸¸æˆ
2. æ·»åŠ å¤šè¯­è¨€ç¿»è¯‘
3. åœ¨å„ä¸ªè¯­è¨€ä¸‹æŸ¥çœ‹æ¸¸æˆ
4. éªŒè¯å›é€€é€»è¾‘ï¼ˆåˆ é™¤æŸä¸ªç¿»è¯‘ååº”æ˜¾ç¤ºè‹±æ–‡ï¼‰

## ç›¸å…³æ–‡ä»¶

- è·¯ç”±é…ç½®: [i18n/routing.ts](../i18n/routing.ts)
- è¯·æ±‚é…ç½®: [i18n/config.ts](../i18n/config.ts)
- ç¿»è¯‘æ–‡ä»¶: [i18n/messages/](../i18n/messages/)
- ä¸­é—´ä»¶: [middleware.ts](../middleware.ts)
- è¾…åŠ©å‡½æ•°: [lib/i18n-helpers.ts](../lib/i18n-helpers.ts)
- æ¸¸æˆå†…å®¹è¾…åŠ©: [lib/helpers/game-content.ts](../lib/helpers/game-content.ts)
