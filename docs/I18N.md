# 国际化文档

## 概述

RunGame 使用 `next-intl` 实现完整的国际化支持，提供类型安全的翻译和路由管理。

**支持语言**:
- 🇬🇧 **en** (English) - 默认语言
- 🇨🇳 **zh** (中文)
- 🇪🇸 **es** (Español)
- 🇫🇷 **fr** (Français)

## 配置文件

### 1. 路由配置 `i18n/routing.ts`

定义语言列表、默认语言，并导出类型安全的导航 API。

```typescript
import { defineRouting } from 'next-intl/routing'
import { createSharedPathnamesNavigation } from 'next-intl/navigation'

export const routing = defineRouting({
  // 支持的语言列表
  locales: ['en', 'zh', 'es', 'fr'],

  // 默认语言
  defaultLocale: 'en',

  // 路由策略
  localePrefix: 'as-needed', // 默认语言无前缀
})

// 导出类型安全的导航 API
export const { Link, redirect, usePathname, useRouter } =
  createSharedPathnamesNavigation(routing)
```

### 2. 请求配置 `i18n/config.ts`

配置如何为每个请求加载翻译消息。

```typescript
import { getRequestConfig } from 'next-intl/server'
import { routing } from './routing'

export default getRequestConfig(async ({ locale }) => {
  // 验证语言是否支持
  if (!routing.locales.includes(locale as any)) {
    notFound()
  }

  return {
    messages: (await import(`./messages/${locale}.json`)).default,
  }
})
```

### 3. 翻译文件 `i18n/messages/`

JSON 格式的翻译文件，每个语言一个文件。

```
i18n/messages/
├── en.json  # 英文翻译
├── zh.json  # 中文翻译
├── es.json  # 西班牙语翻译
└── fr.json  # 法语翻译
```

**示例** (`en.json`):
```json
{
  "home": {
    "title": "Welcome to RunGame",
    "description": "Play free online games"
  },
  "games": {
    "allGames": "All Games",
    "featured": "Featured Games",
    "playNow": "Play Now"
  },
  "navigation": {
    "home": "Home",
    "games": "Games",
    "about": "About",
    "contact": "Contact"
  }
}
```

**对应中文** (`zh.json`):
```json
{
  "home": {
    "title": "欢迎来到 RunGame",
    "description": "免费在线游戏"
  },
  "games": {
    "allGames": "所有游戏",
    "featured": "精选游戏",
    "playNow": "立即游玩"
  },
  "navigation": {
    "home": "首页",
    "games": "游戏",
    "about": "关于",
    "contact": "联系"
  }
}
```

## 路由规则

### URL 格式

- **默认语言 (en)**: 无前缀
  ```
  /games
  /games/play/puzzle-game
  /about
  ```

- **其他语言**: 带语言前缀
  ```
  /zh/games
  /zh/games/play/puzzle-game
  /zh/about

  /es/games
  /fr/games
  ```

### 路由结构

```
app/(site)/[locale]/    # 所有用户路由必须在 [locale] 下
  ├── page.tsx          # 首页: / 或 /zh
  ├── games/
  │   ├── page.tsx      # /games 或 /zh/games
  │   └── play/[slug]/
  │       └── page.tsx  # /games/play/xxx 或 /zh/games/play/xxx
  ├── about/page.tsx
  └── [pageType]/page.tsx
```

## 导航 API

### ⚠️ 重要规则

**在用户网站 (`(site)`) 中**:

❌ **禁止使用** Next.js 原生导航:
```typescript
import Link from 'next/link'              // ❌ 错误
import { useRouter } from 'next/navigation' // ❌ 错误
```

✅ **必须使用** next-intl 导航:
```typescript
import { Link, useRouter, usePathname } from '@/i18n/routing'  // ✅ 正确
```

### 1. Link 组件

```typescript
import { Link } from '@/i18n/routing'

// 基本用法 - 自动添加当前语言前缀
<Link href="/games">All Games</Link>
// 渲染为: /games (en) 或 /zh/games (zh)

// 指定语言
<Link href="/games" locale="zh">中文版</Link>
// 总是渲染为: /zh/games

// 传递参数
<Link href={`/games/play/${slug}`}>Play</Link>

// 外部链接（自动检测）
<Link href="https://external.com">External</Link>
```

### 2. useRouter Hook

```typescript
import { useRouter } from '@/i18n/routing'

function MyComponent() {
  const router = useRouter()

  const handleClick = () => {
    // 编程式导航 - 自动处理语言前缀
    router.push('/games')

    // 指定语言
    router.push('/games', { locale: 'zh' })

    // 替换历史记录
    router.replace('/games')

    // 返回上一页
    router.back()
  }

  return <button onClick={handleClick}>Navigate</button>
}
```

### 3. usePathname Hook

```typescript
import { usePathname } from '@/i18n/routing'

function LanguageSwitcher() {
  const pathname = usePathname()
  // 返回不带语言前缀的路径名: "/games"

  return (
    <div>
      <Link href={pathname} locale="en">English</Link>
      <Link href={pathname} locale="zh">中文</Link>
      <Link href={pathname} locale="es">Español</Link>
      <Link href={pathname} locale="fr">Français</Link>
    </div>
  )
}
```

### 4. redirect 函数 (Server)

```typescript
import { redirect } from '@/i18n/routing'

// Server Component 或 Server Action
export default async function MyPage() {
  const user = await getUser()

  if (!user) {
    redirect('/login')  // 自动处理语言前缀
  }

  // ...
}
```

## 翻译文本

### Server Components

```typescript
import { getTranslations } from 'next-intl/server'

export default async function HomePage({ params }: Props) {
  const { locale } = await params
  const t = await getTranslations()

  return (
    <div>
      <h1>{t('home.title')}</h1>
      <p>{t('home.description')}</p>
    </div>
  )
}
```

### Client Components

```typescript
'use client'

import { useTranslations } from 'next-intl'

export function GameCard() {
  const t = useTranslations('games')

  return (
    <div>
      <button>{t('playNow')}</button>
    </div>
  )
}
```

### 带参数的翻译

```json
{
  "welcome": "Welcome, {name}!",
  "gamesCount": "You have {count} games"
}
```

```typescript
const t = useTranslations()

t('welcome', { name: 'John' })
// 输出: "Welcome, John!"

t('gamesCount', { count: 5 })
// 输出: "You have 5 games"
```

### 复数形式

```json
{
  "gamesCount": "{count, plural, =0 {No games} =1 {One game} other {# games}}"
}
```

```typescript
t('gamesCount', { count: 0 })  // "No games"
t('gamesCount', { count: 1 })  // "One game"
t('gamesCount', { count: 5 })  // "5 games"
```

## 数据库翻译

### 翻译架构

数据库采用翻译分离架构：
- **主表**: 存储不可翻译数据 + **英文内容**
- **翻译表**: 存储**其他语言**的翻译

### 查询翻译数据

#### 辅助函数 `lib/i18n-helpers.ts`

```typescript
/**
 * 构建语言查询条件（当前语言 + en 回退）
 */
export function buildLocaleCondition(locale: string) {
  if (locale === 'en') {
    return { locale: 'en' }
  }

  return {
    locale: { in: [locale, 'en'] }
  }
}

/**
 * 获取翻译内容（带回退）
 */
export function getTranslationWithFallback<T>(
  translations: Array<T & { locale: string }>,
  locale: string
): T | undefined {
  if (locale === 'en') {
    return translations.find(t => t.locale === 'en')
  }

  // 优先当前语言
  const current = translations.find(t => t.locale === locale)
  if (current) return current

  // 回退到英文
  return translations.find(t => t.locale === 'en')
}
```

#### 查询模式

**英文查询** (不需要翻译表):
```typescript
if (locale === 'en') {
  const game = await prisma.game.findUnique({
    where: { slug },
    select: {
      id: true,
      slug: true,
      title: true,        // 直接使用主表英文字段
      description: true,
      // 不加载 translations
    },
  })

  return game
}
```

**其他语言查询** (加载翻译):
```typescript
const game = await prisma.game.findUnique({
  where: { slug },
  include: {
    translations: {
      where: buildLocaleCondition(locale),  // 查询 [locale, 'en']
      select: {
        locale: true,
        title: true,
        description: true,
      },
    },
  },
})

// 获取翻译内容（带回退到英文）
const translation = game.translations.find(t => t.locale === locale)
const title = translation?.title || game.title  // 回退到主表英文
const description = translation?.description || game.description
```

### 翻译辅助函数

`lib/helpers/game-content.ts` 提供统一的翻译获取：

```typescript
import { getGameTitle, getGameDescription } from '@/lib/helpers/game-content'

const title = getGameTitle(locale, game.title, game.translations)
const description = getGameDescription(locale, game.description, game.translations)
```

## 中间件配置

`middleware.ts` 处理语言路由：

```typescript
import createMiddleware from 'next-intl/middleware'
import { routing } from './i18n/routing'

const intlMiddleware = createMiddleware(routing)

export default async function middleware(request: NextRequest) {
  // 1. 国际化路由处理
  const response = intlMiddleware(request)

  // 2. 其他中间件逻辑（认证等）
  // ...

  return response
}

export const config = {
  matcher: [
    // 匹配所有路径除了 api、_next、静态文件
    '/((?!api|_next|.*\\..*).*)',
  ],
}
```

## 语言切换

### 语言切换器组件

```typescript
'use client'

import { usePathname } from '@/i18n/routing'
import { Link } from '@/i18n/routing'

const languages = [
  { code: 'en', name: 'English', flag: '🇬🇧' },
  { code: 'zh', name: '中文', flag: '🇨🇳' },
  { code: 'es', name: 'Español', flag: '🇪🇸' },
  { code: 'fr', name: 'Français', flag: '🇫🇷' },
]

export function LanguageSwitcher() {
  const pathname = usePathname()

  return (
    <div>
      {languages.map((lang) => (
        <Link
          key={lang.code}
          href={pathname}
          locale={lang.code}
        >
          {lang.flag} {lang.name}
        </Link>
      ))}
    </div>
  )
}
```

### 浏览器语言检测

`next-intl` 自动根据以下优先级检测语言：
1. URL 路径中的语言代码
2. Cookie 中保存的语言偏好
3. `Accept-Language` 请求头
4. 默认语言 (en)

## SEO 与国际化

### 生成语言替代链接

```typescript
import { type Metadata } from 'next'

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { locale } = await params

  return {
    alternates: {
      canonical: `/${locale === 'en' ? '' : locale + '/'}games`,
      languages: {
        'en': '/games',
        'zh': '/zh/games',
        'es': '/es/games',
        'fr': '/fr/games',
      },
    },
  }
}
```

### Open Graph 语言标签

```typescript
export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { locale } = await params

  return {
    openGraph: {
      locale: locale,
      alternateLocale: ['en', 'zh', 'es', 'fr'].filter(l => l !== locale),
    },
  }
}
```

## 添加新语言

### 步骤

1. **更新路由配置** `i18n/routing.ts`:
```typescript
export const routing = defineRouting({
  locales: ['en', 'zh', 'es', 'fr', 'de'],  // 添加 'de'
  defaultLocale: 'en',
})
```

2. **创建翻译文件** `i18n/messages/de.json`:
```json
{
  "home": {
    "title": "Willkommen bei RunGame"
  }
}
```

3. **添加到数据库** (Language 表):
```typescript
await prisma.language.create({
  data: {
    code: 'de',
    name: 'German',
    nativeName: 'Deutsch',
    nameCn: '德语',
    isEnabled: true,
    sortOrder: 5,
  },
})
```

4. **为现有内容添加翻译**:
   - 游戏翻译 (GameTranslation)
   - 分类翻译 (CategoryTranslation)
   - 标签翻译 (TagTranslation)
   - 页面类型翻译 (PageTypeTranslation)

## 最佳实践

### 1. 导航

✅ **正确**:
```typescript
import { Link } from '@/i18n/routing'
<Link href="/games">Games</Link>
```

❌ **错误**:
```typescript
import Link from 'next/link'
<Link href="/games">Games</Link>
```

### 2. 路由

✅ **正确**:
```typescript
import { useRouter } from '@/i18n/routing'
const router = useRouter()
router.push('/games')
```

❌ **错误**:
```typescript
import { useRouter } from 'next/navigation'
const router = useRouter()
router.push('/games')
```

### 3. 手动构造 URL

✅ **正确**:
```typescript
<Link href="/games">Games</Link>
// 自动处理: /games (en) 或 /zh/games (zh)
```

❌ **错误**:
```typescript
<Link href={`/${locale}/games`}>Games</Link>
// 可能导致: /en/games (应该是 /games)
```

### 4. 翻译键命名

✅ **正确**:
```json
{
  "games": {
    "title": "Games",
    "playNow": "Play Now"
  }
}
```

❌ **错误**:
```json
{
  "GAMES_TITLE": "Games",
  "play-now": "Play Now"
}
```

使用嵌套对象和驼峰命名。

### 5. 数据库查询

✅ **正确**:
```typescript
// 英文跳过翻译表
translations: locale === 'en' ? false : {
  where: buildLocaleCondition(locale)
}
```

❌ **错误**:
```typescript
// 总是加载翻译表（性能浪费）
translations: {
  where: { locale }
}
```

### 6. 回退处理

✅ **正确**:
```typescript
const translation = translations.find(t => t.locale === locale)
const title = translation?.title || game.title  // 回退到英文
```

❌ **错误**:
```typescript
const title = translations.find(t => t.locale === locale)?.title
// 如果没有翻译，返回 undefined
```

## 常见问题

### 1. 语言切换后页面没有更新

**原因**: 使用了 Next.js 原生 `Link` 而不是 `next-intl` 的 `Link`。

**解决**:
```typescript
import { Link } from '@/i18n/routing'  // ✅ 正确
```

### 2. 默认语言 URL 有多余前缀

**原因**: 手动添加了语言前缀。

**解决**:
```typescript
<Link href="/games">Games</Link>
// 不要写成: <Link href="/en/games">
```

### 3. 翻译不显示

**原因**: 翻译键路径错误或缺少翻译。

**解决**:
1. 检查 JSON 文件中是否有对应的键
2. 检查键路径是否正确 (`games.title` vs `games.playNow`)
3. 确保所有语言都有对应翻译

### 4. 数据库翻译为空

**原因**: 查询条件错误或翻译数据不存在。

**解决**:
1. 使用 `buildLocaleCondition()` 构建查询条件
2. 确保数据库中有对应语言的翻译记录
3. 实现回退到英文的逻辑

## 测试

### 测试不同语言

```bash
# 英文（默认）
http://localhost:3000/games

# 中文
http://localhost:3000/zh/games

# 西班牙语
http://localhost:3000/es/games

# 法语
http://localhost:3000/fr/games
```

### 测试语言切换

1. 访问任意页面
2. 点击语言切换器
3. 验证 URL 和内容都正确更新
4. 验证页面结构保持不变

### 测试数据库翻译

1. 在管理后台创建游戏
2. 添加多语言翻译
3. 在各个语言下查看游戏
4. 验证回退逻辑（删除某个翻译后应显示英文）

## 相关文件

- 路由配置: [i18n/routing.ts](../i18n/routing.ts)
- 请求配置: [i18n/config.ts](../i18n/config.ts)
- 翻译文件: [i18n/messages/](../i18n/messages/)
- 中间件: [middleware.ts](../middleware.ts)
- 辅助函数: [lib/i18n-helpers.ts](../lib/i18n-helpers.ts)
- 游戏内容辅助: [lib/helpers/game-content.ts](../lib/helpers/game-content.ts)
