# R2 CDN 方案选择指南

本文档帮助您根据实际情况选择最合适的 R2 CDN 方案。

## 快速决策树

```
开始
  │
  ├─ 需要自定义域名吗?
  │   ├─ 不需要 → 方案 A: r2.dev 公共域名 ✅ 最简单
  │   │
  │   └─ 需要
  │       │
  │       ├─ 域名已托管在 Cloudflare?
  │       │   ├─ 是 → 方案 B: R2 直接绑定域名 ✅ 最直接
  │       │   │
  │       │   └─ 否
  │       │       │
  │       │       ├─ 愿意迁移 DNS 到 Cloudflare?
  │       │       │   ├─ 是 → 方案 B: R2 直接绑定域名 ✅ 最直接
  │       │       │   │
  │       │       │   └─ 否 → 方案 C: Cloudflare Workers ✅ 最灵活
  │       │       │
  │       │       └─ 需要图片处理等高级功能?
  │       │           └─ 是 → 方案 C: Cloudflare Workers ✅ 最强大
```

---

## 方案对比

| 特性 | 方案 A: r2.dev | 方案 B: 直接绑定 | 方案 C: Workers |
|------|----------------|------------------|-----------------|
| **配置难度** | ⭐ 极简 | ⭐⭐ 简单 | ⭐⭐⭐ 中等 |
| **自定义域名** | ❌ 不支持 | ✅ 支持 | ✅ 支持 |
| **DNS 要求** | 无 | 必须 CF DNS | 任意 DNS |
| **全球 CDN** | ✅ 自动 | ✅ 自动 | ✅ 自动 |
| **图片处理** | ❌ 不支持 | ❌ 不支持 | ✅ 可扩展 |
| **防盗链** | ❌ 不支持 | ❌ 不支持 | ✅ 可实现 |
| **成本** | 完全免费 | 完全免费 | 完全免费* |
| **请求限制** | 无 | 无 | 10万次/天 |
| **适用场景** | 开发测试 | 生产环境 | 生产+高级需求 |

\* Workers 免费额度: 10万次请求/天,超出 $0.15/百万次

---

## 方案详解

### 方案 A: r2.dev 公共域名

**推荐指数**: ⭐⭐⭐⭐⭐ (开发/测试)

**域名示例**:
```
https://pub-a1b2c3d4e5f6.r2.dev/images/test.png
```

**优点**:
- ✅ 零配置,创建 bucket 后立即可用
- ✅ 完全免费,无任何限制
- ✅ 自动全球 CDN 加速
- ✅ 适合快速开始和 MVP

**缺点**:
- ❌ 域名不可自定义,看起来不够专业
- ❌ 无法使用自己的品牌域名

**适用场景**:
- 项目开发和测试阶段
- MVP 验证
- 内部工具
- 对域名无要求的项目

**配置步骤**:
1. 创建 R2 Bucket
2. 启用 Public Access
3. 完成!

**推荐使用**: 如果您正在开发阶段或快速验证想法,这是最佳选择。

---

### 方案 B: R2 直接绑定自定义域名

**推荐指数**: ⭐⭐⭐⭐⭐ (生产环境,域名在 CF)

**域名示例**:
```
https://cdn.yourdomain.com/images/test.png
```

**优点**:
- ✅ 自定义域名,专业品牌形象
- ✅ 零代码,Cloudflare 自动配置
- ✅ 自动 HTTPS 和 CDN
- ✅ 性能最优 (直接连接 R2)

**缺点**:
- ❌ 必须将域名 DNS 托管到 Cloudflare
- ❌ DNS 迁移需要时间 (24-48小时)
- ❌ 无法扩展高级功能

**适用场景**:
- 生产环境
- 域名已在 Cloudflare 或愿意迁移
- 只需要基础 CDN 功能
- 追求最佳性能

**配置步骤**:
1. 将域名添加到 Cloudflare (如未添加)
2. 更改域名 Nameservers 指向 Cloudflare
3. 等待 DNS 生效
4. 在 R2 中绑定自定义域名
5. 完成!

**DNS 迁移影响**:
- ⚠️ 需要临时停机或双重配置
- ⚠️ 所有 DNS 记录需要在 Cloudflare 重新配置
- ✅ 但可享受 Cloudflare 的所有服务 (防护、分析、优化)

**推荐使用**: 如果您的域名已在 Cloudflare,或愿意迁移 DNS 以获得最佳性能。

---

### 方案 C: Cloudflare Workers + 自定义域名

**推荐指数**: ⭐⭐⭐⭐⭐ (域名不在 CF,需要高级功能)

**域名示例**:
```
https://cdn.yourdomain.com/images/test.png
https://cdn.yourdomain.com/images/test.png?width=300  # 支持参数
```

**优点**:
- ✅ 域名可在任意 DNS 服务商 (阿里云、腾讯云等)
- ✅ 无需迁移 DNS,只需添加一条 CNAME
- ✅ 可扩展高级功能 (图片处理、防盗链、自定义缓存)
- ✅ 完全可定制

**缺点**:
- ❌ 需要编写少量 JavaScript 代码
- ❌ 免费额度有限 (10万次/天)
- ❌ 配置相对复杂

**适用场景**:
- 域名在其他 DNS 服务商,不想迁移
- 需要图片尺寸调整、裁剪等功能
- 需要防盗链、访问控制
- 希望完全掌控 CDN 行为
- 日请求量 < 10万次

**配置步骤**:
1. 创建 Cloudflare Worker
2. 编写 R2 访问代码 (提供模板)
3. 绑定 R2 Bucket
4. 配置自定义域名
5. 在当前 DNS 服务商添加 CNAME
6. 完成!

**扩展能力**:
```javascript
// 图片尺寸调整
?width=300&height=200

// 格式转换
?format=webp

// 质量调整
?quality=80

// 防盗链
Referer 验证

// 访问控制
Token 认证

// 缓存控制
自定义 Cache-Control
```

**推荐使用**: 如果您的域名不在 Cloudflare,或需要图片处理等高级功能。

---

## 常见场景推荐

### 场景 1: 刚开始开发,快速上线

**推荐**: 方案 A (r2.dev)

**理由**:
- 零配置,5分钟可用
- 专注开发,不被部署分心
- 后期可随时切换到其他方案

**后续升级路径**:
- 正式上线前切换到方案 B 或 C

---

### 场景 2: 生产环境,域名在阿里云/腾讯云

**推荐**: 方案 C (Workers)

**理由**:
- 无需迁移 DNS,零风险
- 只需添加一条 CNAME,5分钟完成
- 可随时添加图片处理等功能

**配置时间**: 约 15 分钟

---

### 场景 3: 生产环境,域名在 Cloudflare

**推荐**: 方案 B (直接绑定)

**理由**:
- 性能最优,直连 R2
- 零代码,Cloudflare 自动管理
- 简单可靠

**配置时间**: 约 5 分钟

---

### 场景 4: 生产环境,域名在其他服务商,愿意迁移

**推荐**: 方案 B (直接绑定) + DNS 迁移

**理由**:
- 长期最优方案
- 享受 Cloudflare 全套服务
- 性能和安全性最佳

**迁移步骤**:
1. 在 Cloudflare 添加域名
2. 复制所有 DNS 记录到 Cloudflare
3. 更改 Nameservers
4. 等待 24-48 小时生效
5. 绑定 R2 自定义域名

---

### 场景 5: 需要图片处理功能 (缩放、裁剪、格式转换)

**推荐**: 方案 C (Workers) + 扩展功能

**理由**:
- Workers 可调用 Cloudflare Image Resizing
- 支持动态参数 (?width=300)
- 按需处理,节省存储空间

**示例**:
```javascript
// 原图
https://cdn.yourdomain.com/images/banner.jpg

// 自动缩放
https://cdn.yourdomain.com/images/banner.jpg?width=600

// 转换格式
https://cdn.yourdomain.com/images/banner.jpg?format=webp
```

---

### 场景 6: 需要防盗链保护

**推荐**: 方案 C (Workers) + Referer 验证

**理由**:
- Workers 可验证 Referer 头
- 只允许自己网站访问图片
- 防止流量被盗用

**示例代码**:
```javascript
const referer = request.headers.get('referer');
if (!referer || !referer.includes('yourdomain.com')) {
  return new Response('Forbidden', { status: 403 });
}
```

---

## 成本分析

### 方案 A & B: R2 直接访问

**完全免费** (免费额度):
- 存储: 10 GB
- 读取: 1000万次/月
- 写入: 100万次/月
- 出口流量: **无限制,完全免费**

**超出后费用**:
- 存储: $0.015/GB/月
- 读取: $0.36/百万次
- 写入: $4.50/百万次

**预估**: 对于日均 1000 UV 的网站,免费额度足够使用。

---

### 方案 C: Workers

**Workers 免费额度**:
- 10万次请求/天 (300万次/月)
- 10ms CPU 时间/请求

**超出后费用**:
- $0.15/百万次请求
- $0.02/百万 CPU 毫秒

**R2 费用**: 与方案 A/B 相同

**预估**:
- 日均 1000 UV,约 5000 次图片请求/天
- 完全在免费额度内

---

## 迁移指南

### 从方案 A 升级到方案 B

1. 将域名添加到 Cloudflare
2. 在 R2 绑定自定义域名
3. 更新 `R2_PUBLIC_URL` 环境变量
4. 重新部署应用
5. 完成!

**零停机迁移**:
- 同时保留 r2.dev 和自定义域名
- 逐步切换流量

---

### 从方案 A 升级到方案 C

1. 创建 Cloudflare Worker
2. 绑定 R2 Bucket
3. 配置自定义域名
4. 在 DNS 添加 CNAME
5. 更新 `R2_PUBLIC_URL` 环境变量
6. 重新部署应用
7. 完成!

---

### 从方案 B 切换到方案 C

如果后续需要图片处理等功能:

1. 创建 Worker
2. 绑定 R2 Bucket
3. 将自定义域名从 R2 移到 Worker
4. 完成!

**无需**:
- 重新上传文件
- 修改应用代码
- 更改环境变量

---

## 我的推荐

### 如果您正在开发阶段

使用 **方案 A (r2.dev)**
- 配置时间: 5 分钟
- 零门槛,立即开始

### 如果您即将上线,域名在 Cloudflare

使用 **方案 B (直接绑定)**
- 配置时间: 5 分钟
- 性能最优,零维护

### 如果您即将上线,域名不在 Cloudflare

使用 **方案 C (Workers)**
- 配置时间: 15 分钟
- 灵活强大,可扩展

### 如果您需要图片处理

使用 **方案 C (Workers) + 扩展功能**
- 配置时间: 30 分钟
- 一次配置,长期受益

---

## 常见问题

### Q1: 可以先用 r2.dev,后期再换自定义域名吗?

**A**: 可以!只需:
1. 配置自定义域名方案
2. 更新环境变量 `R2_PUBLIC_URL`
3. 重新部署

已上传的文件无需移动,自动通过新域名访问。

---

### Q2: Workers 方案的 10万次/天够用吗?

**A**: 对于大多数网站完全够用:
- 日均 1000 UV → 约 5000 次图片请求
- 日均 10000 UV → 约 50000 次请求
- 只有日均 >20000 UV 才可能超出

超出后费用也很低: $0.15/百万次 = $0.015/10万次

---

### Q3: 必须迁移 DNS 到 Cloudflare 吗?

**A**: 不必须:
- 方案 A: 无需域名
- 方案 B: 需要迁移 DNS
- 方案 C: 无需迁移,只需添加 CNAME

推荐方案 C,灵活度最高。

---

### Q4: 哪个方案性能最好?

**A**: 性能排序:
1. 方案 B (直接绑定) - 最优
2. 方案 C (Workers) - 接近 B,相差 <10ms
3. 方案 A (r2.dev) - 与 B 相同

实际使用中,三者性能差异可忽略。

---

### Q5: 可以同时使用多个方案吗?

**A**: 可以!例如:
- 开发环境: r2.dev
- 测试环境: Workers
- 生产环境: 直接绑定

文件只需上传一次,通过不同 URL 访问即可。

---

## 快速开始

### 现在就开始 (方案 A)

```bash
# 1. 配置 Cloudflare R2 (5分钟)
# 见 docs/R2-CDN-SETUP.md

# 2. 配置环境变量
R2_PUBLIC_URL="https://pub-xxxxx.r2.dev"

# 3. 测试上传
curl -X POST http://localhost:3000/api/upload \
  -F "file=@test.png" \
  -F "type=misc"

# 完成!
```

---

## 相关文档

- [R2 CDN 详细配置](./R2-CDN-SETUP.md) - 完整配置步骤
- [使用示例](./R2-USAGE-EXAMPLE.md) - 代码示例
- [部署总结](./R2-DEPLOYMENT-SUMMARY.md) - 总体方案说明

---

**最后更新**: 2025-01-14
