generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// æ¸¸æˆåˆ†ç±»ï¼ˆä¸»è¡¨ - ä»…å­˜å‚¨éç¿»è¯‘å­—æ®µï¼‰
model Category {
  id           String                 @id @default(cuid())
  slug         String                 @unique
  icon         String?                // åˆ†ç±»å›¾æ ‡ï¼ˆemojiæˆ–å›¾ç‰‡URLï¼‰
  sortOrder    Int                    @default(0) @map("sort_order")
  isEnabled    Boolean                @default(true) @map("is_enabled")  // æ˜¯å¦å¯ç”¨
  createdAt    DateTime               @default(now()) @map("created_at")

  games        Game[]
  translations CategoryTranslation[]

  @@map("categories")
  @@index([slug])
  @@index([sortOrder])
  @@index([isEnabled])
}

// åˆ†ç±»ç¿»è¯‘è¡¨
model CategoryTranslation {
  id              String   @id @default(cuid())
  categoryId      String   @map("category_id")
  locale          String
  name            String
  description     String?
  metaTitle       String?  @map("meta_title")
  metaDescription String?  @map("meta_description")

  category        Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("category_translations")
  @@unique([categoryId, locale])
  @@index([locale])
}

// æ¸¸æˆæ ‡ç­¾ï¼ˆä¸»è¡¨ï¼‰
model Tag {
  id           String           @id @default(cuid())
  slug         String           @unique
  icon         String?          // æ ‡ç­¾å›¾æ ‡ï¼ˆemojiæˆ–å›¾ç‰‡URLï¼‰
  isEnabled    Boolean          @default(true) @map("is_enabled")  // æ˜¯å¦å¯ç”¨
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  games        GameTag[]
  translations TagTranslation[]

  @@map("tags")
  @@index([slug])
  @@index([isEnabled])
}

// æ ‡ç­¾ç¿»è¯‘è¡¨
model TagTranslation {
  id     String @id @default(cuid())
  tagId  String @map("tag_id")
  locale String
  name   String

  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@map("tag_translations")
  @@unique([tagId, locale])
  @@index([locale])
}

// æ¸¸æˆä¸»ä½“ï¼ˆä¸»è¡¨ - ä»…å­˜å‚¨éç¿»è¯‘å­—æ®µï¼‰
model Game {
  id           String            @id @default(cuid())
  slug         String            @unique
  thumbnail    String
  banner       String?
  embedUrl     String            @map("embed_url")
  gameUrl      String            @map("game_url") // æ”¹åä½¿å…¶æ›´æ¸…æ™°
  width        Int               @default(800)
  height       Int               @default(600)
  categoryId   String            @map("category_id")
  isFeatured   Boolean           @default(false) @map("is_featured")
  isPublished  Boolean           @default(false) @map("is_published")
  playCount    Int               @default(0) @map("play_count")
  rating       Float             @default(0)
  ratingCount  Int               @default(0) @map("rating_count")
  metadata     Json?             // é¢å¤–çš„æ¸¸æˆå…ƒæ•°æ®
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")
  publishedAt  DateTime?         @map("published_at")

  category     Category          @relation(fields: [categoryId], references: [id])
  tags         GameTag[]
  translations GameTranslation[]
  views        GameView[]

  @@map("games")
  @@index([slug])
  @@index([categoryId])
  @@index([isFeatured])
  @@index([isPublished])
  @@index([playCount])
}

// æ¸¸æˆç¿»è¯‘è¡¨
model GameTranslation {
  id              String   @id @default(cuid())
  gameId          String   @map("game_id")
  locale          String
  title           String
  description     String?
  longDescription String?  @map("long_description") @db.Text
  instructions    String?  @db.Text
  keywords        String?
  metaTitle       String?  @map("meta_title")
  metaDescription String?  @map("meta_description")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  game            Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@map("game_translations")
  @@unique([gameId, locale])
  @@index([locale])
}

// æ¸¸æˆ-æ ‡ç­¾å…³è”è¡¨
model GameTag {
  gameId String @map("game_id")
  tagId  String @map("tag_id")
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([gameId, tagId])
  @@map("game_tags")
  @@index([gameId])
  @@index([tagId])
}

// UIæ–‡æœ¬ç¿»è¯‘è¡¨ï¼ˆä¸ºåç»­æ‰©å±•å‡†å¤‡ï¼Œç›®å‰åªå­˜å‚¨è‹±æ–‡ï¼‰
model UiTranslation {
  id        String   @id @default(cuid())
  keyName   String   @map("key_name")
  locale    String   @default("en")
  value     String   @db.Text
  context   String?  // ä¸Šä¸‹æ–‡è¯´æ˜ï¼Œå¸®åŠ©ç†è§£ç¿»è¯‘ç”¨é€”
  createdAt DateTime @default(now()) @map("created_at")

  @@map("ui_translations")
  @@unique([keyName, locale])
  @@index([locale])
  @@index([keyName])
}

// æ¸¸æˆè®¿é—®ç»Ÿè®¡ï¼ˆç”¨äº recently played åŠŸèƒ½ï¼‰
model GameView {
  id        String   @id @default(cuid())
  gameId    String   @map("game_id")
  sessionId String   @map("session_id") // ç”¨äºåŒ¿åç”¨æˆ·è¿½è¸ª
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@map("game_views")
  @@index([gameId])
  @@index([sessionId])
  @@index([createdAt])
  @@unique([gameId, sessionId, createdAt]) // é˜²æ­¢åŒä¸€ä¼šè¯çŸ­æ—¶é—´é‡å¤ç»Ÿè®¡
}

// é¡µé¢ç±»å‹ä¸»è¡¨ï¼ˆå­˜å‚¨éç¿»è¯‘å­—æ®µï¼‰
model PageType {
  id              String                 @id @default(cuid())
  slug            String                 @unique           // é¡µé¢æ ‡è¯†ç¬¦ï¼šmost-played, trending, new ç­‰
  type            String                                   // é¡µé¢ç±»å‹ï¼šGAME_LIST, STATIC_CONTENT, MIXED
  icon            String?                                  // é¡µé¢ç±»å‹å›¾æ ‡ï¼ˆemojiæˆ–å›¾ç‰‡URLï¼‰
  isEnabled       Boolean                @default(true)   @map("is_enabled")
  sortOrder       Int                    @default(0)      @map("sort_order")

  // æ¸¸æˆåˆ—è¡¨é…ç½®ï¼ˆå½“typeä¸ºGAME_LISTæ—¶ä½¿ç”¨ï¼‰
  gameListConfig  Json?                  @map("game_list_config")  // æ¸¸æˆç­›é€‰å’Œæ’åºé…ç½®

  // é¡µé¢å¸ƒå±€é…ç½®
  layoutConfig    Json?                  @map("layout_config")     // é¡µé¢å¸ƒå±€è®¾ç½®

  // ç¼“å­˜é…ç½®
  cacheConfig     Json?                  @map("cache_config")      // ç¼“å­˜ç­–ç•¥é…ç½®

  // æ—¶é—´æˆ³
  createdAt       DateTime               @default(now())  @map("created_at")
  updatedAt       DateTime               @updatedAt       @map("updated_at")

  // å…³è”å…³ç³»
  translations    PageTypeTranslation[]
  contentBlocks   PageContentBlock[]

  @@map("page_types")
  @@index([slug])
  @@index([type])
  @@index([isEnabled])
  @@index([sortOrder])
}

// é¡µé¢ç±»å‹ç¿»è¯‘è¡¨
model PageTypeTranslation {
  id              String     @id @default(cuid())
  pageTypeId      String     @map("page_type_id")
  locale          String

  // åŸºç¡€ä¿¡æ¯
  title           String                              // é¡µé¢æ ‡é¢˜
  subtitle        String?                             // é¡µé¢å‰¯æ ‡é¢˜
  description     String?    @db.Text                 // é¡µé¢æè¿°

  // SEOå…ƒä¿¡æ¯
  metaTitle       String?    @map("meta_title")       // SEOæ ‡é¢˜
  metaDescription String?    @map("meta_description")  // SEOæè¿°
  metaKeywords    String?    @map("meta_keywords")    // SEOå…³é”®è¯

  // Open Graphæ ‡ç­¾
  ogTitle         String?    @map("og_title")
  ogDescription   String?    @map("og_description")
  ogImage         String?    @map("og_image")

  // ç»“æ„åŒ–æ•°æ®
  schemaData      Json?      @map("schema_data")      // Schema.orgç»“æ„åŒ–æ•°æ®

  // æ—¶é—´æˆ³
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt      @map("updated_at")

  // å…³è”å…³ç³»
  pageType        PageType   @relation(fields: [pageTypeId], references: [id], onDelete: Cascade)

  @@map("page_type_translations")
  @@unique([pageTypeId, locale])
  @@index([locale])
}

// é¡µé¢å†…å®¹å—è¡¨ï¼ˆæ”¯æŒçµæ´»çš„é¡µé¢å†…å®¹ç»„ç»‡ï¼‰
model PageContentBlock {
  id              String                      @id @default(cuid())
  pageTypeId      String                      @map("page_type_id")

  // å†…å®¹å—é…ç½®
  blockType       String                      @map("block_type")        // HERO, GAME_GRID, TEXT, BANNER, CUSTOM
  blockKey        String                      @map("block_key")         // å†…å®¹å—å”¯ä¸€æ ‡è¯†
  sortOrder       Int                         @default(0) @map("sort_order")
  isEnabled       Boolean                     @default(true) @map("is_enabled")

  // é…ç½®æ•°æ®
  config          Json?                       // å†…å®¹å—é…ç½®ï¼ˆå¸ƒå±€ã€æ ·å¼ç­‰ï¼‰
  conditions      Json?                       // æ˜¾ç¤ºæ¡ä»¶ï¼ˆè®¾å¤‡ç±»å‹ã€ç”¨æˆ·ç±»å‹ç­‰ï¼‰

  // æ—¶é—´æˆ³
  createdAt       DateTime                    @default(now()) @map("created_at")
  updatedAt       DateTime                    @updatedAt @map("updated_at")

  // å…³è”å…³ç³»
  pageType        PageType                    @relation(fields: [pageTypeId], references: [id], onDelete: Cascade)
  translations    PageContentBlockTranslation[]

  @@map("page_content_blocks")
  @@unique([pageTypeId, blockKey])
  @@index([pageTypeId])
  @@index([blockType])
  @@index([sortOrder])
}

// é¡µé¢å†…å®¹å—ç¿»è¯‘è¡¨
model PageContentBlockTranslation {
  id              String           @id @default(cuid())
  blockId         String           @map("block_id")
  locale          String

  // å†…å®¹æ•°æ®
  title           String?                             // å†…å®¹å—æ ‡é¢˜
  content         String?          @db.Text           // å†…å®¹å—å†…å®¹
  buttonText      String?          @map("button_text") // æŒ‰é’®æ–‡æœ¬
  buttonUrl       String?          @map("button_url")  // æŒ‰é’®é“¾æ¥

  // é¢å¤–æ•°æ®
  metadata        Json?                               // å…¶ä»–å…ƒæ•°æ®

  // æ—¶é—´æˆ³
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // å…³è”å…³ç³»
  contentBlock    PageContentBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@map("page_content_block_translations")
  @@unique([blockId, locale])
  @@index([locale])
}

// è¯­è¨€ç®¡ç†è¡¨
model Language {
  id            String    @id @default(cuid())
  code          String    @unique                       // ISO 639-1 è¯­è¨€ä»£ç ï¼šen, zh, esç­‰
  name          String                                  // è‹±æ–‡åç§°ï¼šEnglish, Chinese, Spanish
  nameCn        String    @default("") @map("name_cn") // ä¸­æ–‡åç§°ï¼šè‹±è¯­, ä¸­æ–‡, è¥¿ç­ç‰™è¯­
  nativeName    String    @map("native_name")          // åŸç”Ÿè¯­è¨€åç§°ï¼šEnglish, ä¸­æ–‡, EspaÃ±ol
  flag          String?                                 // æ——å¸œemojiï¼šğŸ‡¬ğŸ‡§, ğŸ‡¨ğŸ‡³, ğŸ‡ªğŸ‡¸
  localeCode    String    @map("locale_code")          // å®Œæ•´åŒºåŸŸä»£ç ï¼šen-US, zh-CN, es-ES
  isDefault     Boolean   @default(false) @map("is_default")  // æ˜¯å¦ä¸ºé»˜è®¤è¯­è¨€
  isEnabled     Boolean   @default(true) @map("is_enabled")   // æ˜¯å¦å¯ç”¨
  sortOrder     Int       @default(0) @map("sort_order")      // æ’åºé¡ºåº
  direction     String    @default("ltr")               // æ–‡å­—æ–¹å‘ï¼šltr, rtl
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("languages")
  @@index([code])
  @@index([isEnabled])
  @@index([isDefault])
  @@index([sortOrder])
}

// ç®¡ç†å‘˜ç”¨æˆ·
model Admin {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String
  name        String?
  role        String    @default("ADMIN") // ADMIN, SUPER_ADMIN
  isActive    Boolean   @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  apiKeys     ApiKey[]

  @@map("admins")
  @@index([email])
}

// APIå¯†é’¥ç®¡ç†
model ApiKey {
  id            String    @id @default(cuid())
  key           String    @unique                 // sk_xxxæ ¼å¼çš„API key
  name          String                            // API keyåç§°/æè¿°
  adminId       String    @map("admin_id")        // åˆ›å»ºè€…ID
  type          String    @default("DISPLAY")     // API Keyç±»å‹ï¼šDISPLAY, ADMIN

  // æƒé™é…ç½®
  scopes        String[]  @default([])            // æƒé™èŒƒå›´ï¼šread:games, write:gamesç­‰

  // å®‰å…¨é…ç½®
  allowedIPs    String[]  @default([]) @map("allowed_ips")      // IPç™½åå•
  allowedDomains String[] @default([]) @map("allowed_domains")  // åŸŸåç™½åå•
  allowedOrigins String[] @default([]) @map("allowed_origins")  // Originç™½åå•

  // ä½¿ç”¨é™åˆ¶
  rateLimit     Int       @default(1000) @map("rate_limit")     // æ¯å°æ—¶è¯·æ±‚é™åˆ¶
  dailyLimit    Int?      @map("daily_limit")                   // æ¯æ—¥è¯·æ±‚é™åˆ¶
  totalLimit    Int?      @map("total_limit")                   // æ€»è¯·æ±‚é™åˆ¶

  // çŠ¶æ€ç®¡ç†
  isActive      Boolean   @default(true) @map("is_active")
  expiresAt     DateTime? @map("expires_at")                    // è¿‡æœŸæ—¶é—´

  // ä½¿ç”¨ç»Ÿè®¡
  usageCount    Int       @default(0) @map("usage_count")       // æ€»ä½¿ç”¨æ¬¡æ•°
  lastUsedAt    DateTime? @map("last_used_at")                  // æœ€åä½¿ç”¨æ—¶é—´
  lastUsedIP    String?   @map("last_used_ip")                  // æœ€åä½¿ç”¨IP

  // æ—¶é—´æˆ³
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  admin         Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("api_keys")
  @@index([key])
  @@index([adminId])
  @@index([isActive])
  @@index([type])
  @@index([lastUsedAt])
}