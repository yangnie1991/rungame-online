// ==================== SEO URLæäº¤ç³»ç»Ÿ ====================
// æ­¤æ–‡ä»¶åŒ…å«æœç´¢å¼•æ“URLæäº¤åŠŸèƒ½æ‰€éœ€çš„æ•°æ®æ¨¡å‹
// ä½¿ç”¨æ—¶éœ€è¦å°†è¿™äº›æ¨¡å‹æ·»åŠ åˆ°ä¸» schema.prisma æ–‡ä»¶ä¸­

// ==================== æšä¸¾å®šä¹‰ ====================

// URLæäº¤çŠ¶æ€æšä¸¾
enum SubmissionStatus {
  PENDING    // å¾…æäº¤
  SUBMITTED  // å·²æäº¤ï¼ˆç­‰å¾…å“åº”ï¼‰
  SUCCESS    // æˆåŠŸ
  FAILED     // å¤±è´¥
  RETRYING   // é‡è¯•ä¸­
}

// æ‰¹é‡æäº¤ä»»åŠ¡çŠ¶æ€æšä¸¾
enum BatchStatus {
  PENDING    // å¾…å¤„ç†
  PROCESSING // å¤„ç†ä¸­
  COMPLETED  // å·²å®Œæˆ
  FAILED     // å¤±è´¥
  CANCELLED  // å·²å–æ¶ˆ
}

// ==================== æ•°æ®æ¨¡å‹ ====================

// æœç´¢å¼•æ“é…ç½®è¡¨
model SearchEngineConfig {
  id       String  @id @default(cuid())

  // ========== åŸºæœ¬ä¿¡æ¯ ==========
  name     String  // æœç´¢å¼•æ“åç§°ï¼šBing, Baidu, Yandex, Google
  slug     String  @unique // æ ‡è¯†ç¬¦ï¼šbing-indexnow, baidu, yandex, google
  type     String  // ç±»å‹ï¼šindexnow, baidu, google, custom
  icon     String? // å›¾æ ‡URLæˆ–emoji (ğŸ”, ğŸŒ)

  description String? // æè¿°ä¿¡æ¯

  // ========== APIé…ç½® ==========
  apiEndpoint String  @map("api_endpoint") // APIç«¯ç‚¹URL
  apiKey      String? @map("api_key")      // APIå¯†é’¥ï¼ˆéœ€åŠ å¯†å­˜å‚¨ï¼‰
  apiToken    String? @map("api_token")    // APIä»¤ç‰Œï¼ˆç™¾åº¦ä½¿ç”¨ï¼‰
  siteUrl     String? @map("site_url")     // ç½‘ç«™URLï¼ˆç™¾åº¦éœ€è¦ï¼‰

  // ========== é¢å¤–é…ç½®ï¼ˆJSONï¼‰==========
  extraConfig Json? @default("{}") @map("extra_config")
  // ç»“æ„ç¤ºä¾‹ï¼š
  // {
  //   "keyLocation": "https://rungame.online/{api-key}.txt",  // IndexNowéªŒè¯æ–‡ä»¶ä½ç½®
  //   "dailyQuota": 500,         // æ¯æ—¥é…é¢é™åˆ¶
  //   "batchSize": 100,          // å•æ¬¡æ‰¹é‡æäº¤å¤§å°
  //   "timeout": 30000,          // APIè¶…æ—¶æ—¶é—´ï¼ˆmsï¼‰
  //   "retryDelay": 60000,       // é‡è¯•å»¶è¿Ÿæ—¶é—´ï¼ˆmsï¼‰
  //   "userAgent": "RunGame Bot" // è‡ªå®šä¹‰User-Agent
  // }

  // ========== çŠ¶æ€é…ç½® ==========
  isEnabled    Boolean @default(true) @map("is_enabled")     // æ˜¯å¦å¯ç”¨
  autoSubmit   Boolean @default(false) @map("auto_submit")   // æ˜¯å¦è‡ªåŠ¨æäº¤ï¼ˆå†…å®¹å‘å¸ƒæ—¶ï¼‰
  sortOrder    Int     @default(0) @map("sort_order")         // æ˜¾ç¤ºæ’åº

  // ========== ç»Ÿè®¡æ•°æ® ==========
  totalSubmitted Int       @default(0) @map("total_submitted") // æ€»æäº¤URLæ•°
  totalSuccess   Int       @default(0) @map("total_success")   // æ€»æˆåŠŸæ•°
  totalFailed    Int       @default(0) @map("total_failed")    // æ€»å¤±è´¥æ•°
  lastSubmitAt   DateTime? @map("last_submit_at")              // æœ€åæäº¤æ—¶é—´

  // ========== æ—¶é—´æˆ³ ==========
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ========== å…³è”å…³ç³» ==========
  submissions UrlSubmission[]

  @@index([slug])
  @@index([type])
  @@index([isEnabled])
  @@index([autoSubmit])
  @@index([sortOrder])
  @@map("search_engine_configs")
}

// URLæäº¤è®°å½•è¡¨
model UrlSubmission {
  id       String @id @default(cuid())

  // ========== æäº¤ä¿¡æ¯ ==========
  url        String // å®Œæ•´URLï¼šhttps://rungame.online/games/play/puzzle-game
  urlType    String @map("url_type") // URLç±»å‹ï¼šgame, category, tag, pagetype, sitemap, other
  entityId   String? @map("entity_id") // å…³è”å®ä½“IDï¼ˆæ¸¸æˆIDã€åˆ†ç±»IDç­‰ï¼‰
  locale     String? // è¯­è¨€ä»£ç ï¼šen, zh, esï¼ˆç”¨äºå¤šè¯­è¨€URLï¼‰

  // ========== æœç´¢å¼•æ“ä¿¡æ¯ ==========
  searchEngineConfigId String @map("search_engine_config_id")
  searchEngineName     String @map("search_engine_name") // å†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢å’Œå±•ç¤º

  // ========== æäº¤çŠ¶æ€ ==========
  status        SubmissionStatus @default(PENDING)
  statusMessage String?          @map("status_message") // çŠ¶æ€æè¿°/é”™è¯¯ä¿¡æ¯

  // ========== HTTPå“åº”ä¿¡æ¯ ==========
  httpStatus    Int?    @map("http_status")     // HTTPçŠ¶æ€ç ï¼š200, 400, 500
  responseBody  String? @map("response_body")   // å“åº”å†…å®¹ï¼ˆJSONæˆ–æ–‡æœ¬ï¼‰
  responseTime  Int?    @map("response_time")   // å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

  // ========== é‡è¯•ä¿¡æ¯ ==========
  retryCount    Int       @default(0) @map("retry_count")    // å½“å‰é‡è¯•æ¬¡æ•°
  maxRetries    Int       @default(3) @map("max_retries")    // æœ€å¤§é‡è¯•æ¬¡æ•°
  nextRetryAt   DateTime? @map("next_retry_at")              // ä¸‹æ¬¡é‡è¯•æ—¶é—´
  lastRetryAt   DateTime? @map("last_retry_at")              // æœ€åé‡è¯•æ—¶é—´

  // ========== æäº¤æ–¹å¼ ==========
  submitMethod  String   @default("manual") @map("submit_method") // manual, auto, batch, cron
  submittedBy   String?  @map("submitted_by") // æäº¤äººï¼ˆç®¡ç†å‘˜IDæˆ– "system"ï¼‰
  batchId       String?  @map("batch_id")     // æ‰€å±æ‰¹æ¬¡IDï¼ˆå¦‚æœæ˜¯æ‰¹é‡æäº¤ï¼‰

  // ========== æ—¶é—´æˆ³ ==========
  createdAt   DateTime  @default(now()) @map("created_at")  // è®°å½•åˆ›å»ºæ—¶é—´
  submittedAt DateTime? @map("submitted_at")                // å®é™…æäº¤æ—¶é—´
  completedAt DateTime? @map("completed_at")                // å®Œæˆæ—¶é—´ï¼ˆæˆåŠŸæˆ–æ°¸ä¹…å¤±è´¥ï¼‰
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // ========== å…³è”å…³ç³» ==========
  searchEngineConfig SearchEngineConfig @relation(fields: [searchEngineConfigId], references: [id], onDelete: Cascade)

  @@unique([url, searchEngineConfigId, locale], name: "unique_url_engine_locale") // é˜²æ­¢é‡å¤æäº¤
  @@index([url])
  @@index([status])
  @@index([urlType])
  @@index([entityId])
  @@index([searchEngineConfigId])
  @@index([batchId])
  @@index([createdAt])
  @@index([submittedAt])
  @@index([nextRetryAt])
  @@index([submitMethod])
  @@map("url_submissions")
}

// æ‰¹é‡æäº¤ä»»åŠ¡è¡¨
model SubmissionBatch {
  id String @id @default(cuid())

  // ========== æ‰¹æ¬¡ä¿¡æ¯ ==========
  name        String      // æ‰¹æ¬¡åç§°ï¼šå¦‚ "å‘å¸ƒæ‰€æœ‰æ¸¸æˆåˆ°Bing"
  description String?     // æ‰¹æ¬¡æè¿°
  status      BatchStatus @default(PENDING)

  // ========== ç»Ÿè®¡ä¿¡æ¯ ==========
  totalUrls     Int @default(0) @map("total_urls")     // æ€»URLæ•°
  processedUrls Int @default(0) @map("processed_urls") // å·²å¤„ç†æ•°
  successUrls   Int @default(0) @map("success_urls")   // æˆåŠŸæ•°
  failedUrls    Int @default(0) @map("failed_urls")    // å¤±è´¥æ•°
  pendingUrls   Int @default(0) @map("pending_urls")   // å¾…å¤„ç†æ•°

  // ========== é…ç½®ä¿¡æ¯ ==========
  searchEngineConfigIds String[] @default([]) @map("search_engine_config_ids") // ç›®æ ‡æœç´¢å¼•æ“IDåˆ—è¡¨

  // URLç­›é€‰æ¡ä»¶ï¼ˆJSONï¼‰
  urlFilters Json? @default("{}") @map("url_filters")
  // ç»“æ„ç¤ºä¾‹ï¼š
  // {
  //   "urlTypes": ["game", "category"],           // URLç±»å‹ç­›é€‰
  //   "locales": ["en", "zh"],                     // è¯­è¨€ç­›é€‰
  //   "entityStatus": "PUBLISHED",                // å®ä½“çŠ¶æ€ç­›é€‰
  //   "entityIds": ["id1", "id2"],                // æŒ‡å®šå®ä½“ID
  //   "dateRange": {                               // æ—¶é—´èŒƒå›´ç­›é€‰
  //     "from": "2025-01-01",
  //     "to": "2025-01-31",
  //     "field": "createdAt"                       // createdAt, updatedAt
  //   }
  // }

  // ========== æ‰§è¡Œä¿¡æ¯ ==========
  startedAt   DateTime? @map("started_at")   // å¼€å§‹å¤„ç†æ—¶é—´
  completedAt DateTime? @map("completed_at") // å®Œæˆæ—¶é—´
  cancelledAt DateTime? @map("cancelled_at") // å–æ¶ˆæ—¶é—´

  errorMessage String?  @map("error_message") // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰

  createdBy String @map("created_by") // åˆ›å»ºäººï¼ˆç®¡ç†å‘˜IDæˆ– "system"ï¼‰

  // ========== æ—¶é—´æˆ³ ==========
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@index([createdBy])
  @@map("submission_batches")
}

// ==================== è¯´æ˜ ====================

// 1. å¦‚ä½•æ·»åŠ åˆ°ä¸»schema:
//    - å¤åˆ¶ä¸Šè¿°æšä¸¾å’Œæ¨¡å‹å®šä¹‰åˆ° prisma/schema.prisma
//    - è¿è¡Œ `npx prisma format` æ ¼å¼åŒ–
//    - è¿è¡Œ `npx prisma db push` æ¨é€åˆ°æ•°æ®åº“
//    - è¿è¡Œ `npx prisma generate` ç”Ÿæˆå®¢æˆ·ç«¯

// 2. æ•°æ®å®‰å…¨:
//    - apiKey å’Œ apiToken å­—æ®µåº”è¯¥åŠ å¯†å­˜å‚¨
//    - å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–ä¸“ç”¨çš„å¯†é’¥ç®¡ç†æœåŠ¡
//    - åœ¨æ˜¾ç¤ºæ—¶åªå±•ç¤ºéƒ¨åˆ†å­—ç¬¦ï¼ˆå¦‚ï¼šsk-***123ï¼‰

// 3. ç´¢å¼•ä¼˜åŒ–:
//    - ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ äº†ç´¢å¼•
//    - uniqueçº¦æŸé˜²æ­¢é‡å¤æäº¤
//    - å¯æ ¹æ®å®é™…æŸ¥è¯¢æ¨¡å¼è¿›ä¸€æ­¥ä¼˜åŒ–

// 4. JSONå­—æ®µè¯´æ˜:
//    - extraConfig: å­˜å‚¨æœç´¢å¼•æ“ç‰¹å®šçš„é…ç½®
//    - urlFilters: å­˜å‚¨æ‰¹é‡æäº¤çš„ç­›é€‰æ¡ä»¶
//    - ä½¿ç”¨JSONæä¾›çµæ´»æ€§ï¼Œæ”¯æŒæœªæ¥æ‰©å±•

// 5. å…³è”å…³ç³»:
//    - SearchEngineConfig -> UrlSubmission (ä¸€å¯¹å¤š)
//    - UrlSubmission é€šè¿‡ batchId å…³è”åˆ° SubmissionBatch
//    - ä½¿ç”¨ onDelete: Cascade è‡ªåŠ¨æ¸…ç†å…³è”æ•°æ®
